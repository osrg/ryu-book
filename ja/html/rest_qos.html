<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>QoS &#8212; Ryubook 1.0 ドキュメント</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="top" title="Ryubook 1.0 ドキュメント" href="index.html" />
    <link rel="next" title="OpenFlowスイッチテストツール" href="switch_test_tool.html" />
    <link rel="prev" title="ルータ" href="rest_router.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="switch_test_tool.html" title="OpenFlowスイッチテストツール"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="rest_router.html" title="ルータ"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ryubook 1.0 ドキュメント</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="qos">
<span id="ch-rest-qos"></span><h1>QoS<a class="headerlink" href="#qos" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>本章では、RESTで設定が出来るQoS機能の使用方法について説明します。</p>
<div class="section" id="id1">
<h2>QoSについて<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>QoS(Quality of Service)とはネットワーク上でデータの種類に応じた優先順位に従ってデータを転送したり、ある特定の通信の為にネットワーク帯域を予約し、一定の通信速度で通信できるようにする技術です。OpenFlowでは帯域制御によるQoSが実現できます。</p>
</div>
<div class="section" id="id2">
<h2>フロー単位のQoSの動作例<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>以下のようなトポロジを想定し、スイッチにQueueの設定とルールを追加し適切な帯域幅を割り当てる例を紹介します。また、OFS1のWAN側インターフェースでトラフィックシェーピングを行う場合を想定しています。</p>
<a class="reference internal image-reference" href="_images/fig15.png"><img alt="_images/fig15.png" class="align-center" src="_images/fig15.png" style="width: 280.0px; height: 85.6px;" /></a>
<div class="section" id="id3">
<h3>環境構築<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>まずはMininet上に環境を構築します。<code class="docutils literal"><span class="pre">mn</span></code>コマンドのパラメータは以下のようになります。</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="15%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">パラメータ</th>
<th class="head">値</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>mac</td>
<td>なし</td>
<td>自動的にホストのMACアドレスをセットする</td>
</tr>
<tr class="row-odd"><td>switch</td>
<td>ovsk</td>
<td>Open vSwitchを使用する</td>
</tr>
<tr class="row-even"><td>controller</td>
<td>remote</td>
<td>OpenFlowコントローラは外部のものを利用する</td>
</tr>
<tr class="row-odd"><td>x</td>
<td>なし</td>
<td>xtermを起動する</td>
</tr>
</tbody>
</table>
<p>実行例は以下のようになります。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span>$ sudo mn --mac --switch ovsk --controller remote -x
*** Creating network
*** Adding controller
Unable to contact the remote controller at 127.0.0.1:6633
*** Adding hosts:
h1 h2
*** Adding switches:
s1
*** Adding links:
(h1, s1) (h2, s1)
*** Configuring hosts
h1 h2
*** Running terms on localhost:10.0
*** Starting controller
*** Starting 1 switches
s1
*** Starting CLI:
mininet&gt;
</pre></div>
</div>
<p>また、コントローラ用のxtermをもうひとつ起動しておきます。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">c0</span>
<span class="n">mininet</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>続いて、スイッチで使用するOpenFlowのバージョンを1.3に設定します。また、OVSDBへアクセスを行うため、6632ポートで待ち受けるように設定します。</p>
<p>switch: s1 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ovs-vsctl set Bridge s1 protocols=OpenFlow13</span>
<span class="c1"># ovs-vsctl set-manager ptcp:6632</span>
</pre></div>
</div>
<p>続いて、「<a class="reference internal" href="switching_hub.html#ch-switching-hub"><span class="std std-ref">スイッチングハブ</span></a>」で使用したsimple_switch_13.pyを変更します。rest_qos.pyはフローテーブルのパイプライン上で処理される事を想定しているため、simple_switch_13.pyのフローエントリをtable id:1に登録するように変更します。</p>
<p>controller: c0 (root)</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># sed &#39;/OFPFlowMod(/,/)/s/)/, table_id=1)/&#39; ryu/ryu/app/simple_switch_13.py &gt; ryu/ryu/app/qos_simple_switch_13.py</span>
<span class="c1"># cd ryu/; python ./setup.py install</span>
</pre></div>
</div>
<p>最後に、コントローラのxterm上でrest_qos、qos_simple_switch_13、rest_conf_switchを起動させます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ryu-manager ryu.app.rest_qos ryu.app.qos_simple_switch_13 ryu.app.rest_conf_switch</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_simple_switch_13</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_conf_switch</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">DPSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">dpset</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">ConfSwitchSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">conf_switch</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">wsgi</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_conf_switch</span> <span class="n">of</span> <span class="n">ConfSwitchAPI</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_simple_switch_13</span> <span class="n">of</span> <span class="n">SimpleSwitch13</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span> <span class="n">of</span> <span class="n">OFPHandler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span> <span class="n">of</span> <span class="n">RestQoSAPI</span>
<span class="p">(</span><span class="mi">3519</span><span class="p">)</span> <span class="n">wsgi</span> <span class="n">starting</span> <span class="n">up</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span>
</pre></div>
</div>
<p>Ryuとスイッチの間の接続に成功すると、次のメッセージが表示されます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
</pre></div>
</div>
<p>上記ログが表示されれば、準備完了です。</p>
</div>
<div class="section" id="queue">
<h3>Queueの設定<a class="headerlink" href="#queue" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>スイッチにQueueを設定します。</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="36%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">キューID</th>
<th class="head">最大レート</th>
<th class="head">最小レート</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>500Kbps</td>
<td>-</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>(1Mbps)</td>
<td>800Kbps</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">以降の説明で使用するREST APIの詳細は、章末の「<a class="reference internal" href="#rest-api">REST API一覧</a>」を参照してください。</p>
</div>
<p>まずは、OVSDBへアクセスする為の設定を行います。</p>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X PUT -d &#39;&quot;tcp:127.0.0.1:6632&quot;&#39; http://localhost:8080/v1.0/conf/switches/0000000000000001/ovsdb_addr</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>続いて、Queueの設定を行います。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;port_name&quot;: &quot;s1-eth1&quot;, &quot;type&quot;: &quot;linux-htb&quot;, &quot;max_rate&quot;: &quot;1000000&quot;, &quot;queues&quot;: [{&quot;max_rate&quot;: &quot;500000&quot;}, {&quot;min_rate&quot;: &quot;800000&quot;}]}&#39; http://localhost:8080/qos/queue/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;max-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;500000&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;min-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;800000&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">RESTコマンドの実行結果は見やすいように整形しています。</p>
</div>
</div>
<div class="section" id="id4">
<h3>QoSの設定<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下の通りスイッチにフローの設定を行います。</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="19%" />
<col width="19%" />
<col width="17%" />
<col width="13%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">(優先度)</th>
<th class="head">宛先</th>
<th class="head">宛先ポート</th>
<th class="head">プロトコル</th>
<th class="head">Queue ID</th>
<th class="head">(QoS ID)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>10.0.0.1</td>
<td>5002</td>
<td>UDP</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;nw_dst&quot;: &quot;10.0.0.1&quot;, &quot;nw_proto&quot;: &quot;UDP&quot;, &quot;tp_dst&quot;: &quot;5002&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>設定内容の確認<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各スイッチに設定された内容を確認します。</p>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;nw_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;UDP&quot;</span><span class="p">,</span>
              <span class="s2">&quot;tp_dst&quot;</span><span class="p">:</span> <span class="mi">5002</span><span class="p">,</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;nw_dst&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.1&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>帯域計測<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この状態で、iperfで帯域計測をしてみます。h1はサーバとなりプロトコルはUDPで5001ポートと5002ポートで待ち受けます。h2はクライアントとなりh1の5001ポートに1MbpsのUDPトラフィック、h1の5002ポートに1MbpsのUDPトラフィックを送出します。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">以降の例では、帯域計測にiperf(<a class="reference external" href="http://iperf.fr/">http://iperf.fr/</a>)を使用します。iperfのインストール、使用方法については、本稿では解説しません。</p>
</div>
<p>まず、h1、h2のターミナルを一つずつ起動します。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h1</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h2</span>
</pre></div>
</div>
<p>Node: h1(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -s -u -i 1 -p 5001</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h1(2) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -s -u -i 1 -p 5002</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h2(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5001 -u -b 1M</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h2(2) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5002 -u -b 1M</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h1(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5001</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">port</span> <span class="mi">50375</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>        <span class="n">Jitter</span>   <span class="n">Lost</span><span class="o">/</span><span class="n">Total</span> <span class="n">Datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span> <span class="mf">1.0</span> <span class="n">sec</span>  <span class="mf">60.3</span> <span class="n">KBytes</span>   <span class="mi">494</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.208</span> <span class="n">ms</span>    <span class="mi">4</span><span class="o">/</span>   <span class="mi">42</span> <span class="p">(</span><span class="mf">9.5</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span> <span class="mf">1.0</span> <span class="n">sec</span>  <span class="mi">4</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">1.0</span><span class="o">-</span> <span class="mf">2.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.538</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">2.0</span><span class="o">-</span> <span class="mf">3.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.494</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">3.0</span><span class="o">-</span> <span class="mf">4.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.625</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">4.0</span><span class="o">-</span> <span class="mf">5.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.576</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">5.0</span><span class="o">-</span> <span class="mf">6.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.561</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">6.0</span><span class="o">-</span> <span class="mf">7.0</span> <span class="n">sec</span>  <span class="mf">11.5</span> <span class="n">KBytes</span>  <span class="mf">94.1</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">45.536</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">8</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">7.0</span><span class="o">-</span> <span class="mf">8.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">92.790</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">8.0</span><span class="o">-</span> <span class="mf">9.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">135.391</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">9.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">167.045</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">10.0</span><span class="o">-</span><span class="mf">11.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">193.006</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">11.0</span><span class="o">-</span><span class="mf">12.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">213.944</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">12.0</span><span class="o">-</span><span class="mf">13.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">231.981</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">13.0</span><span class="o">-</span><span class="mf">14.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">249.758</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">14.0</span><span class="o">-</span><span class="mf">15.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">261.139</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">15.0</span><span class="o">-</span><span class="mf">16.0</span> <span class="n">sec</span>  <span class="mf">4.31</span> <span class="n">KBytes</span>  <span class="mf">35.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">269.879</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">3</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">16.0</span><span class="o">-</span><span class="mf">17.0</span> <span class="n">sec</span>  <span class="mf">12.9</span> <span class="n">KBytes</span>   <span class="mi">106</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">204.755</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">9</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">17.0</span><span class="o">-</span><span class="mf">18.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">26.214</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">18.0</span><span class="o">-</span><span class="mf">19.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">13.485</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">19.0</span><span class="o">-</span><span class="mf">20.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.690</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">20.0</span><span class="o">-</span><span class="mf">21.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.498</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">21.0</span><span class="o">-</span><span class="mf">22.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.601</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">22.0</span><span class="o">-</span><span class="mf">23.0</span> <span class="n">sec</span>  <span class="mf">60.3</span> <span class="n">KBytes</span>   <span class="mi">494</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.640</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">42</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">23.0</span><span class="o">-</span><span class="mf">24.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.508</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">24.0</span><span class="o">-</span><span class="mf">25.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.578</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">25.0</span><span class="o">-</span><span class="mf">26.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.541</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">26.0</span><span class="o">-</span><span class="mf">27.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.539</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">27.0</span><span class="o">-</span><span class="mf">28.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.578</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">28.0</span><span class="o">-</span><span class="mf">29.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.527</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">29.0</span><span class="o">-</span><span class="mf">30.0</span> <span class="n">sec</span>  <span class="mf">58.9</span> <span class="n">KBytes</span>   <span class="mi">482</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.542</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">41</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">30.6</span> <span class="n">sec</span>  <span class="mf">1.19</span> <span class="n">MBytes</span>   <span class="mi">327</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.562</span> <span class="n">ms</span>    <span class="mi">4</span><span class="o">/</span>  <span class="mi">852</span> <span class="p">(</span><span class="mf">0.47</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">30.6</span> <span class="n">sec</span>  <span class="mi">4</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
</pre></div>
</div>
<p>Node: h1(2) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5002</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">port</span> <span class="mi">60868</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>        <span class="n">Jitter</span>   <span class="n">Lost</span><span class="o">/</span><span class="n">Total</span> <span class="n">Datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span> <span class="mf">1.0</span> <span class="n">sec</span>   <span class="mi">112</span> <span class="n">KBytes</span>   <span class="mi">917</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.288</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">78</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">1.0</span><span class="o">-</span> <span class="mf">2.0</span> <span class="n">sec</span>   <span class="mi">115</span> <span class="n">KBytes</span>   <span class="mi">941</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.168</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">80</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">2.0</span><span class="o">-</span> <span class="mf">3.0</span> <span class="n">sec</span>   <span class="mi">115</span> <span class="n">KBytes</span>   <span class="mi">941</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.454</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">80</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">3.0</span><span class="o">-</span> <span class="mf">4.0</span> <span class="n">sec</span>   <span class="mi">113</span> <span class="n">KBytes</span>   <span class="mi">929</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.226</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">79</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">4.0</span><span class="o">-</span> <span class="mf">5.0</span> <span class="n">sec</span>   <span class="mi">113</span> <span class="n">KBytes</span>   <span class="mi">929</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.096</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">79</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">5.0</span><span class="o">-</span> <span class="mf">6.0</span> <span class="n">sec</span>   <span class="mi">113</span> <span class="n">KBytes</span>   <span class="mi">929</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.225</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">79</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">6.0</span><span class="o">-</span> <span class="mf">7.0</span> <span class="n">sec</span>   <span class="mi">113</span> <span class="n">KBytes</span>   <span class="mi">929</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.055</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">79</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">7.0</span><span class="o">-</span> <span class="mf">8.0</span> <span class="n">sec</span>   <span class="mi">113</span> <span class="n">KBytes</span>   <span class="mi">929</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.241</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">79</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">8.0</span><span class="o">-</span> <span class="mf">9.0</span> <span class="n">sec</span>   <span class="mi">115</span> <span class="n">KBytes</span>   <span class="mi">941</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">3.886</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">80</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">9.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">112</span> <span class="n">KBytes</span>   <span class="mi">917</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">3.969</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">78</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.8</span> <span class="n">sec</span>  <span class="mf">1.19</span> <span class="n">MBytes</span>   <span class="mi">931</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">4.287</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>  <span class="mi">852</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>結果から分かる通りに5001ポート宛のトラフィックは帯域制限により500Kbps以下にシェーピングされ、5002ポート宛のトラフィックは800kbpsの帯域保証が行われていることが分かります。</p>
</div>
</div>
<div class="section" id="diffservqos">
<h2>DiffServによるQoSの動作例<a class="headerlink" href="#diffservqos" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>先ほどの例ではフロー毎にQoSを行いましたが、きめ細かい制御ができる反面、扱うフローが増加するに伴い、帯域制御を行う各スイッチに設定するフローも増加し、スケーラブルではありません。そこでフロー毎にQoSを行うのではなく、DiffServドメインの入り口のルータでフローをいくつかのクラスに分け、クラス毎の制御を行うDiffServを適用します。DiffServではIPヘッダのToSフィールド内の6ビットのDSCP値を使用し、DSCP値により定義されるPHBに従って転送することで、QoSを実現します。</p>
<p>以下のようなトポロジを想定し、スイッチ(ルータ)OFS1にQueueの設定とクラスに応じた帯域制御を設定し、ルータOFS2にはフローに応じたDSCP値をマーキングを行うルールを適用する例を紹介します。また、OFS1のWAN側インターフェースでトラフィックシェーピングを行う場合を想定しています。</p>
<a class="reference internal image-reference" href="_images/fig23.png"><img alt="_images/fig23.png" class="align-center" src="_images/fig23.png" style="width: 289.6px; height: 103.6px;" /></a>
<div class="section" id="id7">
<h3>環境構築<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>まずはMininet上に環境を構築します。<code class="docutils literal"><span class="pre">mn</span></code>コマンドのパラメータは以下のようになります。</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="15%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">パラメータ</th>
<th class="head">値</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>topo</td>
<td>linear,2</td>
<td>2台のスイッチが直列に接続されているトポロジ</td>
</tr>
<tr class="row-odd"><td>mac</td>
<td>なし</td>
<td>自動的にホストのMACアドレスをセットする</td>
</tr>
<tr class="row-even"><td>switch</td>
<td>ovsk</td>
<td>Open vSwitchを使用する</td>
</tr>
<tr class="row-odd"><td>controller</td>
<td>remote</td>
<td>OpenFlowコントローラは外部のものを利用する</td>
</tr>
<tr class="row-even"><td>x</td>
<td>なし</td>
<td>xtermを起動する</td>
</tr>
</tbody>
</table>
<p>実行例は以下のようになります。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span>$ sudo mn --topo linear,2 --mac --switch ovsk --controller remote -x
*** Creating network
*** Adding controller
Unable to contact the remote controller at 127.0.0.1:6633
*** Adding hosts:
h1 h2
*** Adding switches:
s1
*** Adding links:
(h1, s1) (h2, s1)
*** Configuring hosts
h1 h2
*** Running terms on localhost:10.0
*** Starting controller
*** Starting 1 switches
s1
*** Starting CLI:
mininet&gt;
</pre></div>
</div>
<p>また、コントローラ用のxtermをもうひとつ起動しておきます。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">c0</span>
<span class="n">mininet</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>続いて、スイッチで使用するOpenFlowのバージョンを1.3に設定します。また、OVSDBへアクセスを行うため、6632ポートで待ち受けるように設定します。</p>
<p>switch: s1 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ovs-vsctl set Bridge s1 protocols=OpenFlow13</span>
<span class="c1"># ovs-vsctl set-manager ptcp:6632</span>
</pre></div>
</div>
<p>switch: s2 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ovs-vsctl set Bridge s2 protocols=OpenFlow13</span>
</pre></div>
</div>
<p>その後、各ホストで自動的に割り当てられているIPアドレスを削除し、新たにIPアドレスを設定します。</p>
<p>host: h1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ip addr del 10.0.0.1/8 dev h1-eth0</span>
<span class="c1"># ip addr add 172.16.20.10/24 dev h1-eth0</span>
</pre></div>
</div>
<p>host: h2:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ip addr del 10.0.0.2/8 dev h2-eth0</span>
<span class="c1"># ip addr add 172.16.10.10/24 dev h2-eth0</span>
</pre></div>
</div>
<p>続いて、「<a class="reference internal" href="rest_router.html#ch-rest-router"><span class="std std-ref">ルータ</span></a>」で使用したrest_router.pyを変更します。rest_qos.pyはフローテーブルのパイプライン上で処理される事を想定しているため、rest_router.pyのフローエントリをtable id:1に登録するように変更します。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># sed &#39;/OFPFlowMod(/,/)/s/0, cmd/1, cmd/&#39; ryu/ryu/app/rest_router.py &gt; ryu/ryu/app/qos_rest_router.py</span>
<span class="c1"># cd ryu/; python ./setup.py install</span>
</pre></div>
</div>
<p>最後に、コントローラのxterm上でrest_qos、qos_rest_router、rest_conf_switchを起動させます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ryu-manager ryu.app.rest_qos ryu.app.qos_rest_router ryu.app.rest_conf_switch</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_rest_router</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_conf_switch</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">DPSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">dpset</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">ConfSwitchSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">conf_switch</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">wsgi</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_conf_switch</span> <span class="n">of</span> <span class="n">ConfSwitchAPI</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_rest_router</span> <span class="n">of</span> <span class="n">RestRouterAPI</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span> <span class="n">of</span> <span class="n">OFPHandler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span> <span class="n">of</span> <span class="n">RestQoSAPI</span>
<span class="p">(</span><span class="mi">4687</span><span class="p">)</span> <span class="n">wsgi</span> <span class="n">starting</span> <span class="n">up</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span>
</pre></div>
</div>
<p>Ryuとスイッチの間の接続に成功すると、次のメッセージが表示されます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Set</span> <span class="n">SW</span> <span class="n">config</span> <span class="k">for</span> <span class="n">TTL</span> <span class="n">error</span> <span class="n">packet</span> <span class="ow">in</span><span class="o">.</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Set</span> <span class="n">ARP</span> <span class="n">handling</span> <span class="p">(</span><span class="n">packet</span> <span class="ow">in</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Set</span> <span class="n">L2</span> <span class="n">switching</span> <span class="p">(</span><span class="n">normal</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Set</span> <span class="n">default</span> <span class="n">route</span> <span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Start</span> <span class="n">cyclic</span> <span class="n">routing</span> <span class="n">table</span> <span class="n">update</span><span class="o">.</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Join</span> <span class="k">as</span> <span class="n">router</span><span class="o">.</span>
<span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Set</span> <span class="n">SW</span> <span class="n">config</span> <span class="k">for</span> <span class="n">TTL</span> <span class="n">error</span> <span class="n">packet</span> <span class="ow">in</span><span class="o">.</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Set</span> <span class="n">ARP</span> <span class="n">handling</span> <span class="p">(</span><span class="n">packet</span> <span class="ow">in</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Set</span> <span class="n">L2</span> <span class="n">switching</span> <span class="p">(</span><span class="n">normal</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Set</span> <span class="n">default</span> <span class="n">route</span> <span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="n">flow</span> <span class="p">[</span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">]</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Start</span> <span class="n">cyclic</span> <span class="n">routing</span> <span class="n">table</span> <span class="n">update</span><span class="o">.</span>
<span class="p">[</span><span class="n">RT</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">switch_id</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Join</span> <span class="k">as</span> <span class="n">router</span><span class="o">.</span>
<span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
</pre></div>
</div>
<p>上記ログが表示されれば、準備完了です。</p>
</div>
<div class="section" id="id8">
<h3>Queueの設定<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="27%" />
<col width="27%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">キューID</th>
<th class="head">最大レート</th>
<th class="head">最小レート</th>
<th class="head">クラス</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>1Mbps</td>
<td>-</td>
<td>Default</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>(1Mbps)</td>
<td>200Kbps</td>
<td>AF3</td>
</tr>
<tr class="row-even"><td>2</td>
<td>(1Mbps)</td>
<td>500Kbps</td>
<td>AF4</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">以降の説明で使用するREST APIの詳細は、章末の「<a class="reference internal" href="#rest-api">REST API一覧</a>」を参照してください。</p>
</div>
<p>まずは、OVSDBへアクセスする為の設定を行います。</p>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X PUT -d &#39;&quot;tcp:127.0.0.1:6632&quot;&#39; http://localhost:8080/v1.0/conf/switches/0000000000000001/ovsdb_addr</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>続いて、Queueの設定を行います。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;port_name&quot;: &quot;s1-eth1&quot;, &quot;type&quot;: &quot;linux-htb&quot;, &quot;max_rate&quot;: &quot;1000000&quot;, &quot;queues&quot;:[{&quot;max_rate&quot;: &quot;1000000&quot;}, {&quot;min_rate&quot;: &quot;200000&quot;}, {&quot;min_rate&quot;: &quot;500000&quot;}]}&#39; http://localhost:8080/qos/queue/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;max-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;min-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;200000&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;min-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;500000&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">RESTコマンドの実行結果は見やすいように整形しています。</p>
</div>
</div>
<div class="section" id="id9">
<h3>ルータの設定<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各ルータへアドレスの設定、デフォルトルートの設定を行います。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;address&quot;: &quot;172.16.20.1/24&quot;}&#39; http://localhost:8080/router/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add address [address_id=1]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;address&quot;: &quot;172.16.30.10/24&quot;}&#39; http://localhost:8080/router/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add address [address_id=2]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;gateway&quot;: &quot;172.16.30.1&quot;}&#39; http://localhost:8080/router/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add route [route_id=1]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;address&quot;: &quot;172.16.10.1/24&quot;}&#39; http://localhost:8080/router/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add address [address_id=1]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;address&quot;: &quot;172.16.30.1/24&quot;}&#39; http://localhost:8080/router/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add address [address_id=2]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;gateway&quot;: &quot;172.16.30.10&quot;}&#39; http://localhost:8080/router/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Add route [route_id=1]&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
<p>ルータへのIPアドレスの設定ができたので、各ホストにデフォルトゲートウェイとして登録します。</p>
<p>host: h1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ip route add default via 172.16.20.1</span>
</pre></div>
</div>
<p>host: h2:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ip route add default via 172.16.10.1</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>QoSの設定<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下の通りルータ(s1)にDSCP値に応じた制御を行うフローを設定します。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="27%" />
<col width="27%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">(優先度)</th>
<th class="head">DSCP</th>
<th class="head">キューID</th>
<th class="head">(QoS ID)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>26(AF31)</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>34(AF41)</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;26&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;34&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;2&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=2&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
<p>以下の通りルータ(s2)にマーキングを行うフローの設定を行います。</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="19%" />
<col width="19%" />
<col width="17%" />
<col width="13%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">(優先度)</th>
<th class="head">宛先</th>
<th class="head">宛先ポート</th>
<th class="head">プロトコル</th>
<th class="head">DSCP</th>
<th class="head">(QoS ID)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>172.16.20.10</td>
<td>5002</td>
<td>UDP</td>
<td>26(AF31)</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>172.16.20.10</td>
<td>5003</td>
<td>UDP</td>
<td>34(AF41)</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;nw_dst&quot;: &quot;172.16.20.10&quot;, &quot;nw_proto&quot;: &quot;UDP&quot;, &quot;tp_dst&quot;: &quot;5002&quot;}, &quot;actions&quot;:{&quot;mark&quot;: &quot;26&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;nw_dst&quot;: &quot;172.16.20.10&quot;, &quot;nw_proto&quot;: &quot;UDP&quot;, &quot;tp_dst&quot;: &quot;5003&quot;}, &quot;actions&quot;:{&quot;mark&quot;: &quot;34&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=2&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>設定内容の確認<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各スイッチに設定された内容を確認します。</p>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;nw_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;UDP&quot;</span><span class="p">,</span>
              <span class="s2">&quot;tp_dst&quot;</span><span class="p">:</span> <span class="mi">5002</span><span class="p">,</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;nw_dst&quot;</span><span class="p">:</span> <span class="s2">&quot;172.16.20.10&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;mark&quot;</span><span class="p">:</span> <span class="s2">&quot;26&quot;</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;nw_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;UDP&quot;</span><span class="p">,</span>
              <span class="s2">&quot;tp_dst&quot;</span><span class="p">:</span> <span class="mi">5003</span><span class="p">,</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s2">&quot;nw_dst&quot;</span><span class="p">:</span> <span class="s2">&quot;172.16.20.10&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;mark&quot;</span><span class="p">:</span> <span class="s2">&quot;34&quot;</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>帯域計測<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この状態で、iperfで帯域計測をしてみます。h1はサーバとなりプロトコルはUDPで5001ポートと5002ポートと5003ポートで待ち受けます。h2はクライアントとなりh1の5001ポートに1MbpsのUDPトラフィック、h1の5002ポートに300KbpsのUDPトラフィック、h1の5003ポートに600KbpsのUDPトラフィックを送出します。</p>
<p>まず、h2のターミナルを2つ起動します。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h2</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h2</span>
</pre></div>
</div>
<p>Node: h1(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -s -u -p 5002 &amp;</span>
<span class="o">...</span>
<span class="c1"># iperf -s -u -p 5003 &amp;</span>
<span class="o">...</span>
<span class="c1"># iperf -s -u -i 1 5001</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Server</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="n">Receiving</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
</pre></div>
</div>
<p>Node: h2(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 172.16.20.10 -p 5001 -u -b 1M</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h2(2) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 172.16.20.10 -p 5002 -u -b 300K</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">20.10</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">10.10</span> <span class="n">port</span> <span class="mi">44077</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">20.10</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.1</span> <span class="n">sec</span>   <span class="mi">369</span> <span class="n">KBytes</span>   <span class="mi">300</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">257</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.2</span> <span class="n">sec</span>   <span class="mi">369</span> <span class="n">KBytes</span>   <span class="mi">295</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">17.379</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>  <span class="mi">257</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>Node: h2(3) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 172.16.20.10 -p 5003 -u -b 600K</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">20.10</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5003</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">10.10</span> <span class="n">port</span> <span class="mi">59280</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">20.10</span> <span class="n">port</span> <span class="mi">5003</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">512</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">5.401</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>  <span class="mi">512</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>Node: h1(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">20.10</span> <span class="n">port</span> <span class="mi">5001</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">10.10</span> <span class="n">port</span> <span class="mi">37329</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>        <span class="n">Jitter</span>   <span class="n">Lost</span><span class="o">/</span><span class="n">Total</span> <span class="n">Datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span> <span class="mf">1.0</span> <span class="n">sec</span>   <span class="mi">119</span> <span class="n">KBytes</span>   <span class="mi">976</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.639</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">83</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">1.0</span><span class="o">-</span> <span class="mf">2.0</span> <span class="n">sec</span>   <span class="mi">118</span> <span class="n">KBytes</span>   <span class="mi">964</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.680</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">82</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">2.0</span><span class="o">-</span> <span class="mf">3.0</span> <span class="n">sec</span>  <span class="mf">87.6</span> <span class="n">KBytes</span>   <span class="mi">717</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">5.817</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">61</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">3.0</span><span class="o">-</span> <span class="mf">4.0</span> <span class="n">sec</span>  <span class="mf">81.8</span> <span class="n">KBytes</span>   <span class="mi">670</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">5.700</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">57</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">4.0</span><span class="o">-</span> <span class="mf">5.0</span> <span class="n">sec</span>  <span class="mf">66.0</span> <span class="n">KBytes</span>   <span class="mi">541</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">12.772</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">46</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">5.0</span><span class="o">-</span> <span class="mf">6.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">60.590</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">6.0</span><span class="o">-</span> <span class="mf">7.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">89.968</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">7.0</span><span class="o">-</span> <span class="mf">8.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">108.364</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">8.0</span><span class="o">-</span> <span class="mf">9.0</span> <span class="n">sec</span>  <span class="mf">10.0</span> <span class="n">KBytes</span>  <span class="mf">82.3</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">125.635</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">7</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">9.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">130.604</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">10.0</span><span class="o">-</span><span class="mf">11.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">140.192</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">11.0</span><span class="o">-</span><span class="mf">12.0</span> <span class="n">sec</span>  <span class="mf">8.61</span> <span class="n">KBytes</span>  <span class="mf">70.6</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">144.411</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>    <span class="mi">6</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">12.0</span><span class="o">-</span><span class="mf">13.0</span> <span class="n">sec</span>  <span class="mf">28.7</span> <span class="n">KBytes</span>   <span class="mi">235</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">63.964</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">20</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">13.0</span><span class="o">-</span><span class="mf">14.0</span> <span class="n">sec</span>  <span class="mf">44.5</span> <span class="n">KBytes</span>   <span class="mi">365</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">26.721</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">31</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">14.0</span><span class="o">-</span><span class="mf">15.0</span> <span class="n">sec</span>  <span class="mf">57.4</span> <span class="n">KBytes</span>   <span class="mi">470</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">9.396</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">40</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">15.0</span><span class="o">-</span><span class="mf">16.0</span> <span class="n">sec</span>   <span class="mi">118</span> <span class="n">KBytes</span>   <span class="mi">964</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.956</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">82</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">16.0</span><span class="o">-</span><span class="mf">17.0</span> <span class="n">sec</span>   <span class="mi">119</span> <span class="n">KBytes</span>   <span class="mi">976</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.820</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">83</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">17.0</span><span class="o">-</span><span class="mf">18.0</span> <span class="n">sec</span>   <span class="mi">118</span> <span class="n">KBytes</span>   <span class="mi">964</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.741</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">82</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="mf">18.0</span><span class="o">-</span><span class="mf">19.0</span> <span class="n">sec</span>   <span class="mi">118</span> <span class="n">KBytes</span>   <span class="mi">964</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.839</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>   <span class="mi">82</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">19.7</span> <span class="n">sec</span>  <span class="mf">1.19</span> <span class="n">MBytes</span>   <span class="mi">508</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">0.981</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>  <span class="mi">852</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>AF41にマーキングされているトラフィックは500Kbpsの帯域保証がされ、AF31にマーキングされているトラフィックは200Kbpsの帯域保証がされています。一方、ベストエフォートのトラフィックはAFにマーキングされているトラフィックが流れている間は帯域幅が狭められているのが分かります。このようにDiffServによりQoSを実現できることが確認できました。</p>
</div>
</div>
<div class="section" id="meter-tableqos">
<h2>Meter Tableを使用したQoSの動作例<a class="headerlink" href="#meter-tableqos" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>OpenFlow 1.3よりMeter Tableが導入されOpenFlowでトラフィックのポリシングが可能となりました。Meter Tableの利用例について紹介します。こちらの例では、Meter TableをサポートするOpenFlow Switchのofsoftswitch13(<a class="reference external" href="https://github.com/CPqD/ofsoftswitch13">https://github.com/CPqD/ofsoftswitch13</a>)を使用します。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ofsoftswitch13のインストール手順などについては本稿では解説しません。参考:(<a class="reference external" href="https://github.com/CPqD/ofsoftswitch13/wiki/OpenFlow-1.3-Tutorial">https://github.com/CPqD/ofsoftswitch13/wiki/OpenFlow-1.3-Tutorial</a>)</p>
</div>
<p>以下のように複数のDiffServドメイン(DSドメイン)により構成されているネットワークを想定します。DSドメインの境界に位置するルータ(エッジルータ)によってメータリングが行われ、指定帯域を超えるトラフィックは再マーキングされます。通常再マーキングされたパケットは優先的に破棄されるか、優先順位の低いクラスとして扱われます。例では、AF1クラスに対して800Kbpsの帯域保証を行い、各DSドメインから流入するAF11のトラフィックの400Kbpsを契約帯域とし、それ以上は超過トラフィックとしてパケットはAF12に再マーキングされます。ただし、AF12はベストエフォートのトラフィックよりは保証されるように設定しています。</p>
<a class="reference internal image-reference" href="_images/fig33.png"><img alt="_images/fig33.png" class="align-center" src="_images/fig33.png" style="width: 414.4px; height: 279.6px;" /></a>
<div class="section" id="id13">
<h3>環境構築<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>まずはMininet上に環境を構築します。トポロジの作成はPythonスクリプトで行います。</p>
<p>ソース名：<code class="docutils literal"><span class="pre">qos_sample_topology.py</span></code></p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mininet.net</span> <span class="k">import</span> <span class="n">Mininet</span>
<span class="kn">from</span> <span class="nn">mininet.cli</span> <span class="k">import</span> <span class="n">CLI</span>
<span class="kn">from</span> <span class="nn">mininet.topo</span> <span class="k">import</span> <span class="n">Topo</span>
<span class="kn">from</span> <span class="nn">mininet.node</span> <span class="k">import</span> <span class="n">UserSwitch</span>
<span class="kn">from</span> <span class="nn">mininet.node</span> <span class="k">import</span> <span class="n">RemoteController</span>

<span class="k">class</span> <span class="nc">SliceableSwitch</span><span class="p">(</span><span class="n">UserSwitch</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">UserSwitch</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyTopo</span><span class="p">(</span><span class="n">Topo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="s2">&quot;Create custom topo.&quot;</span>
        <span class="c1"># Initialize topology</span>
        <span class="n">Topo</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="c1"># Add hosts and switches</span>
        <span class="n">host01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span>
        <span class="n">host02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">)</span>
        <span class="n">host03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
        <span class="n">switch01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span><span class="s1">&#39;s1&#39;</span><span class="p">)</span>
        <span class="n">switch02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span><span class="s1">&#39;s2&#39;</span><span class="p">)</span>
        <span class="n">switch03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
        <span class="c1"># Add links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">host01</span><span class="p">,</span> <span class="n">switch01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">host02</span><span class="p">,</span> <span class="n">switch02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">host03</span><span class="p">,</span> <span class="n">switch03</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">switch01</span><span class="p">,</span> <span class="n">switch02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">switch01</span><span class="p">,</span> <span class="n">switch03</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">getNodeByName</span><span class="p">(</span><span class="s1">&#39;s1&#39;</span><span class="p">)</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">cmdPrint</span><span class="p">(</span><span class="s1">&#39;dpctl unix:/tmp/s1 queue-mod 1 1 80&#39;</span><span class="p">)</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">cmdPrint</span><span class="p">(</span><span class="s1">&#39;dpctl unix:/tmp/s1 queue-mod 1 2 120&#39;</span><span class="p">)</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">cmdPrint</span><span class="p">(</span><span class="s1">&#39;dpctl unix:/tmp/s1 queue-mod 1 3 800&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">genericTest</span><span class="p">(</span><span class="n">topo</span><span class="p">):</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">Mininet</span><span class="p">(</span><span class="n">topo</span><span class="o">=</span><span class="n">topo</span><span class="p">,</span> <span class="n">switch</span><span class="o">=</span><span class="n">SliceableSwitch</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="n">RemoteController</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">run</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">CLI</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">topo</span> <span class="o">=</span> <span class="n">MyTopo</span><span class="p">()</span>
    <span class="n">genericTest</span><span class="p">(</span><span class="n">topo</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>あらかじめofsoftswitch13のリンクスピードを1Mbpsに変更します。</p>
<p>まず、ofsoftswitch13のソースコードを修正します。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span>$ cd ofsoftswitch13
$ gedit lib/netdev.c
</pre></div>
</div>
<p>lib/netdev.c:</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="mi">644</span>           <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">.</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">645</span>               <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">|=</span> <span class="n">OFPPF_AUTONEG</span><span class="p">;</span>
<span class="mi">646</span>           <span class="p">}</span>
<span class="mi">647</span>
<span class="mi">648</span> <span class="o">-</span>         <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">.</span><span class="n">speed</span><span class="p">;</span>
<span class="mi">649</span> <span class="o">+</span>         <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">Fix</span> <span class="n">to</span> <span class="mi">1</span><span class="n">Mbps</span> <span class="n">link</span> <span class="o">*/</span>
<span class="mi">650</span>
<span class="mi">651</span>       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">652</span>           <span class="n">VLOG_DBG</span><span class="p">(</span><span class="n">LOG_MODULE</span><span class="p">,</span> <span class="s2">&quot;ioctl(SIOCETHTOOL) failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="mi">653</span>       <span class="p">}</span>
</pre></div>
</div>
<p>そして、ofsoftswitch13を再インストールします。</p>
<div class="console last highlight-default"><div class="highlight"><pre><span></span>$ make clean
$ ./boot.sh
$ ./configure
$ make
$ sudo make install
</pre></div>
</div>
</div>
<p>実行例は以下の通りになります</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span>$ curl -O https://raw.githubusercontent.com/osrg/ryu-book/master/sources/qos_sample_topology.py
$ sudo python ./qos_sample_topology.py
Unable to contact the remote controller at 127.0.0.1:6633
mininet&gt;
</pre></div>
</div>
<p>また、コントローラ用のxtermを2つ起動しておきます。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">c0</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">c0</span>
<span class="n">mininet</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>続いて、「<a class="reference internal" href="switching_hub.html#ch-switching-hub"><span class="std std-ref">スイッチングハブ</span></a>」で使用したsimple_switch_13.pyを変更します。rest_qos.pyはフローテーブルのパイプライン上で処理される事を想定しているため、simple_switch_13.pyのフローエントリをtable id:1に登録するように変更します。</p>
<p>controller: c0 (root)</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># sed &#39;/OFPFlowMod(/,/)/s/)/, table_id=1)/&#39; ryu/ryu/app/simple_switch_13.py &gt; ryu/ryu/app/qos_simple_switch_13.py</span>
<span class="c1"># cd ryu/; python ./setup.py install</span>
</pre></div>
</div>
<p>最後に、コントローラのxterm上でrest_qos、qos_simple_switch_13を起動させます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># ryu-manager ryu.app.rest_qos ryu.app.qos_simple_switch_13</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_simple_switch_13</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">DPSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">dpset</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="kc">None</span> <span class="n">of</span> <span class="n">ConfSwitchSet</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">conf_switch</span>
<span class="n">creating</span> <span class="n">context</span> <span class="n">wsgi</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qos_simple_switch_13</span> <span class="n">of</span> <span class="n">SimpleSwitch13</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span> <span class="n">of</span> <span class="n">OFPHandler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rest_qos</span> <span class="n">of</span> <span class="n">RestQoSAPI</span>
<span class="p">(</span><span class="mi">2348</span><span class="p">)</span> <span class="n">wsgi</span> <span class="n">starting</span> <span class="n">up</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span>
</pre></div>
</div>
<p>Ryuとスイッチの間の接続に成功すると、次のメッセージが表示されます。</p>
<p>controller: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000003</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
<span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000001</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
<span class="p">[</span><span class="n">QoS</span><span class="p">][</span><span class="n">INFO</span><span class="p">]</span> <span class="n">dpid</span><span class="o">=</span><span class="mi">0000000000000002</span><span class="p">:</span> <span class="n">Join</span> <span class="n">qos</span> <span class="n">switch</span><span class="o">.</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h3>QoSの設定<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下の通りスイッチ(s1)にDSCP値に応じた制御を行うフローを設定します。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="27%" />
<col width="27%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">(優先度)</th>
<th class="head">DSCP</th>
<th class="head">キューID</th>
<th class="head">(QoS ID)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>0 (BE)</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>12(AF12)</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="row-even"><td>1</td>
<td>10(AF11)</td>
<td>3</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;0&quot;, &quot;in_port&quot;: &quot;2&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;10&quot;, &quot;in_port&quot;: &quot;2&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;3&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=2&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;12&quot;, &quot;in_port&quot;: &quot;2&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;2&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=3&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;0&quot;, &quot;in_port&quot;: &quot;3&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=4&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;10&quot;, &quot;in_port&quot;: &quot;3&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;3&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=5&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;12&quot;, &quot;in_port&quot;: &quot;3&quot;}, &quot;actions&quot;:{&quot;queue&quot;: &quot;2&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=6&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
<p>以下の通りスイッチ(s2、s3)にメータエントリーを設定します。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="27%" />
<col width="27%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">(優先度)</th>
<th class="head">DSCP</th>
<th class="head">メータID</th>
<th class="head">(QoS ID)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>10(AF11)</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="21%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">メータID</th>
<th class="head">Flags</th>
<th class="head">Bands</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>KBPS</td>
<td>type:DSCP_REMARK,rate:400000,prec_level:1</td>
</tr>
</tbody>
</table>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;10&quot;}, &quot;actions&quot;:{&quot;meter&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;meter_id&quot;: &quot;1&quot;, &quot;flags&quot;: &quot;KBPS&quot;, &quot;bands&quot;:[{&quot;type&quot;:&quot;DSCP_REMARK&quot;, &quot;rate&quot;: &quot;400&quot;, &quot;prec_level&quot;: &quot;1&quot;}]}&#39; http://localhost:8080/qos/meter/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Meter added. : Meter ID=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;match&quot;: {&quot;ip_dscp&quot;: &quot;10&quot;}, &quot;actions&quot;:{&quot;meter&quot;: &quot;1&quot;}}&#39; http://localhost:8080/qos/rules/0000000000000003</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000003&quot;</span><span class="p">,</span>
    <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;QoS added. : qos_id=1&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># curl -X POST -d &#39;{&quot;meter_id&quot;: &quot;1&quot;, &quot;flags&quot;: &quot;KBPS&quot;, &quot;bands&quot;:[{&quot;type&quot;:&quot;DSCP_REMARK&quot;, &quot;rate&quot;: &quot;400&quot;, &quot;prec_level&quot;: &quot;1&quot;}]}&#39; http://localhost:8080/qos/meter/0000000000000003</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000003&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
          <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Meter added. : Meter ID=1&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3>設定内容の確認<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各スイッチに設定された内容を確認します。</p>
<p>Node: c0 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000001</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">10</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">12</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">4</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">10</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
              <span class="s2">&quot;in_port&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">12</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000002</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000002&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;meter&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># curl -X GET http://localhost:8080/qos/rules/0000000000000003</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;switch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0000000000000003&quot;</span><span class="p">,</span>
      <span class="s2">&quot;command_result&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s2">&quot;dl_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IPv4&quot;</span><span class="p">,</span>
              <span class="s2">&quot;ip_dscp&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
              <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="s2">&quot;meter&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="s2">&quot;qos_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h3>帯域計測<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この状態で、iperfで帯域計測をしてみます。h1はサーバとなりプロトコルはUDPで5001ポートと5002ポートと5003ポートで待ち受けます。h2、h3はクライアントとなりh1宛に各クラスのトラフィックを送出します。</p>
<p>まず、h1とh2で2つとh3の1つづつターミナルを起動します。</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h1</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h2</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h3</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">xterm</span> <span class="n">h3</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Node: h1(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -s -u -p 5001 &amp;</span>
<span class="c1"># iperf -s -u -p 5002 &amp;</span>
<span class="c1"># iperf -s -u -p 5003 &amp;</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="section" id="af11">
<h4>ベストエフォートと超過したAF11トラフィック<a class="headerlink" href="#af11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Node: h2 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5001 -u -b 800K</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.3</span> <span class="n">port</span> <span class="mi">60324</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">979</span> <span class="n">KBytes</span>   <span class="mi">800</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">682</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">11.9</span> <span class="n">sec</span>   <span class="mi">650</span> <span class="n">KBytes</span>   <span class="mi">449</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">18.458</span> <span class="n">ms</span>  <span class="mi">229</span><span class="o">/</span>  <span class="mi">682</span> <span class="p">(</span><span class="mi">34</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>Node: h3(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5002 -u -b 600K --tos 0x28</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">port</span> <span class="mi">53661</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">512</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>   <span class="mf">7.497</span> <span class="n">ms</span>    <span class="mi">6</span><span class="o">/</span>  <span class="mi">512</span> <span class="p">(</span><span class="mf">1.2</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>  <span class="mi">6</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
</pre></div>
</div>
<p>AF11のトラフィックが契約帯域400Kbpsを超過した場合でもベストエフォートのトラフィックより帯域が保証されている事が分かります。</p>
</div>
<div class="section" id="af11af11">
<h4>AF11の超過トラフィックとベストエフォートとAF11の契約帯域内トラフィック<a class="headerlink" href="#af11af11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Node: h2 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5001 -u -b 600K --tos 0x28</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">port</span> <span class="mi">49358</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">512</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">666</span> <span class="n">KBytes</span>   <span class="mi">544</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">500.361</span> <span class="n">ms</span>   <span class="mi">48</span><span class="o">/</span>  <span class="mi">512</span> <span class="p">(</span><span class="mf">9.4</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>  <span class="mi">192</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
</pre></div>
</div>
<p>Node: h3(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5002 -u -b 500K</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.3</span> <span class="n">port</span> <span class="mi">42759</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">613</span> <span class="n">KBytes</span>   <span class="mi">500</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">427</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">receive</span> <span class="n">ack</span> <span class="n">of</span> <span class="n">last</span> <span class="n">datagram</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">tries</span><span class="o">.</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">14.0</span> <span class="n">sec</span>   <span class="mi">359</span> <span class="n">KBytes</span>   <span class="mi">210</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">102.479</span> <span class="n">ms</span>  <span class="mi">177</span><span class="o">/</span>  <span class="mi">427</span> <span class="p">(</span><span class="mi">41</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>Node: h3(2) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5003 -u -b 400K --tos 0x28</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5003</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.3</span> <span class="n">port</span> <span class="mi">35475</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5003</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.1</span> <span class="n">sec</span>   <span class="mi">491</span> <span class="n">KBytes</span>   <span class="mi">400</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">342</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.5</span> <span class="n">sec</span>   <span class="mi">491</span> <span class="n">KBytes</span>   <span class="mi">384</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">15.422</span> <span class="n">ms</span>    <span class="mi">0</span><span class="o">/</span>  <span class="mi">342</span> <span class="p">(</span><span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>400Kbpsの契約帯域内のトラフィックはドロップされていない事がわかります。</p>
</div>
<div class="section" id="id17">
<h4>AF11の超過トラフィックとAF11の超過トラフィック<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Node: h2 (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5001 -u -b 600K --tos 0x28</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.3</span> <span class="n">port</span> <span class="mi">50761</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5001</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">512</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">11.0</span> <span class="n">sec</span>   <span class="mi">673</span> <span class="n">KBytes</span>   <span class="mi">501</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">964.490</span> <span class="n">ms</span>   <span class="mi">43</span><span class="o">/</span>  <span class="mi">512</span> <span class="p">(</span><span class="mf">8.4</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">11.0</span> <span class="n">sec</span>  <span class="mi">95</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
</pre></div>
</div>
<p>Node: h3(1) (root):</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="c1"># iperf -c 10.0.0.1 -p 5002 -u -b 600K --tos 0x28</span>
<span class="o">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">UDP</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="n">Sending</span> <span class="mi">1470</span> <span class="n">byte</span> <span class="n">datagrams</span>
<span class="n">UDP</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span>  <span class="mi">208</span> <span class="n">KByte</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="o">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">local</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">port</span> <span class="mi">53066</span> <span class="n">connected</span> <span class="k">with</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5002</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">sec</span>   <span class="mi">735</span> <span class="n">KBytes</span>   <span class="mi">600</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Sent</span> <span class="mi">512</span> <span class="n">datagrams</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span> <span class="n">Server</span> <span class="n">Report</span><span class="p">:</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.6</span> <span class="n">sec</span>   <span class="mi">665</span> <span class="n">KBytes</span>   <span class="mi">515</span> <span class="n">Kbits</span><span class="o">/</span><span class="n">sec</span>  <span class="mf">897.126</span> <span class="n">ms</span>   <span class="mi">49</span><span class="o">/</span>  <span class="mi">512</span> <span class="p">(</span><span class="mf">9.6</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span>  <span class="mi">4</span><span class="p">]</span>  <span class="mf">0.0</span><span class="o">-</span><span class="mf">10.6</span> <span class="n">sec</span>  <span class="mi">93</span> <span class="n">datagrams</span> <span class="n">received</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">order</span>
</pre></div>
</div>
<p>超過トラフィックは同程度にドロップされている事が分かります。</p>
<p>本章では、具体例を挙げながらQoS REST APIの使用方法を説明しました。</p>
</div>
</div>
</div>
<div class="section" id="rest-api">
<h2>REST API一覧<a class="headerlink" href="#rest-api" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>本章で紹介したrest_qosのREST API一覧です。</p>
<div class="section" id="id18">
<h3>キューの状態の取得<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>GET</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/queue/status/{<strong>switch</strong>}</p>
<p class="last">&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id19">
<h3>キューの設定情報の取得<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>GET</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/queue/{<strong>switch</strong>}</p>
<p class="last">&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>備考</strong></td>
<td>QoS REST APIを起動した後有効にしたキューの設定情報のみ取得できます。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id20">
<h3>キューの設定<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>POST</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/queue/{<strong>switch</strong>}</p>
<p class="last">&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>データ</strong></td>
<td><p class="first"><strong>port_name</strong>:[設定対象のポート名]</p>
<p><strong>type</strong>:[linux-htb | linux-hfsc]</p>
<p><strong>max_rate</strong>:[帯域幅(bps)]</p>
<p><strong>queues</strong>:</p>
<blockquote class="last">
<div><p><strong>max_rate</strong>:[帯域幅(bps)]</p>
<p><strong>min_rate</strong>:[帯域幅(bps)]</p>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><strong>備考</strong></td>
<td><p class="first">既存の設定が存在する場合は上書きされます。</p>
<p>OpenvSwitchにのみ設定が可能です。</p>
<p>port_nameパラメータはオプションです。</p>
<p class="last">port_nameを指定しない場合は全てのポートに設定されます。</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id21">
<h3>キューの削除<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>DELETE</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/queue/{<strong>swtich</strong>}</p>
<p class="last">&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>備考</strong></td>
<td>OVSDBのQoSレコードとの関連を削除します。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id22">
<h3>全QoSルールの取得<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>GET</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/rules/{<strong>switch</strong>}[/{<strong>vlan</strong>}]</p>
<p>&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
<p class="last">&#8211;<strong>vlan</strong>: [ &#8220;all&#8221; |<em>VLAN ID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>備考</strong></td>
<td>VLAN IDの指定はオプションです。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id23">
<h3>QoSルールの追加<a class="headerlink" href="#id23" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>POST</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/rules/{<strong>switch</strong>}[/{<strong>vlan</strong>}]</p>
<p>&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
<p class="last">&#8211;<strong>vlan</strong>: [ &#8220;all&#8221; |<em>VLAN ID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>データ</strong></td>
<td><p class="first"><strong>priority</strong>:[ 0 - 65535 ]</p>
<p><strong>match</strong>:</p>
<blockquote>
<div><p><strong>in_port</strong>:[ 0 - 65535 ]</p>
<p><strong>dl_src</strong>:&#8221;&lt;xx:xx:xx:xx:xx:xx&gt;&#8221;</p>
<p><strong>dl_dst</strong>:&#8221;&lt;xx:xx:xx:xx:xx:xx&gt;&#8221;</p>
<p><strong>dl_type</strong>:[ &#8220;ARP&#8221; | &#8220;IPv4&#8221; ]</p>
<p><strong>nw_src</strong>:&#8221;&lt;xxx.xxx.xxx.xxx/xx&gt;&#8221;</p>
<p><strong>nw_dst</strong>:&#8221;&lt;xxx.xxx.xxx.xxx/xx&gt;&#8221;</p>
<p><strong>nw_proto</strong>&#8221;:[ &#8220;TCP&#8221; | &#8220;UDP&#8221; | &#8220;ICMP&#8221; ]</p>
<p><strong>tp_src</strong>:[ 0 - 65535 ]</p>
<p><strong>tp_dst</strong>:[ 0 - 65535 ]</p>
<p><strong>ip_dscp</strong>:[ 0 - 63 ]</p>
</div></blockquote>
<p><strong>actions</strong>:</p>
<blockquote class="last">
<div>[ &#8220;mark&#8221;: [ 0 - 63  ] ] |[ &#8220;meter&#8221;: [ メーターID ] ] |[ &#8220;queue&#8221;: [ キューID ] ]</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><strong>備考</strong></td>
<td><p class="first">登録に成功するとQoS IDが生成され、応答に記載されます。</p>
<p class="last">VLAN IDの指定はオプションです。</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id24">
<h3>QoSルールの削除<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>DELETE</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/rules/{<strong>switch</strong>}[/{<strong>vlan</strong>}]</p>
<p>&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
<p class="last">&#8211;<strong>vlan</strong>: [ &#8220;all&#8221; |<em>VLAN ID</em>]</p>
</td>
</tr>
<tr class="row-odd"><td><strong>データ</strong></td>
<td><strong>rule_id</strong>:[ &#8220;all&#8221; | 1 - ... ]</td>
</tr>
<tr class="row-even"><td><strong>備考</strong></td>
<td>VLAN IDの指定はオプションです。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id25">
<h3>メーターテーブルの情報取得<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>GET</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td><p class="first">/qos/meter/{<strong>switch</strong>}</p>
<p class="last">&#8211;<strong>switch</strong>: [ &#8220;all&#8221; |<em>スイッチID</em>]</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id26">
<h3>メーターテーブルの設定<a class="headerlink" href="#id26" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>メソッド</strong></td>
<td>POST</td>
</tr>
<tr class="row-even"><td><strong>URL</strong></td>
<td>/qos/meter/{<strong>switch</strong>}</td>
</tr>
<tr class="row-odd"><td><strong>データ</strong></td>
<td><p class="first"><strong>meter_id</strong>:メータID</p>
<p><strong>bands</strong>:</p>
<blockquote class="last">
<div><p><strong>action</strong>:[DROP | DSCP_REMARK]</p>
<p><strong>flags</strong>:[KBPS | PKTPS | BURST | STATS]</p>
<p><strong>burst_size</strong>:[バーストサイズ]</p>
<p><strong>rate</strong>:[受信レート]</p>
<p><strong>prec_level</strong>:[リマークする破棄優先度レベル]</p>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><strong>備考</strong></td>
<td>bandsで指定する、また有効になるパラメータはactionやflagsによって異なります。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">QoS</a><ul>
<li><a class="reference internal" href="#id1">QoSについて</a></li>
<li><a class="reference internal" href="#id2">フロー単位のQoSの動作例</a><ul>
<li><a class="reference internal" href="#id3">環境構築</a></li>
<li><a class="reference internal" href="#queue">Queueの設定</a></li>
<li><a class="reference internal" href="#id4">QoSの設定</a></li>
<li><a class="reference internal" href="#id5">設定内容の確認</a></li>
<li><a class="reference internal" href="#id6">帯域計測</a></li>
</ul>
</li>
<li><a class="reference internal" href="#diffservqos">DiffServによるQoSの動作例</a><ul>
<li><a class="reference internal" href="#id7">環境構築</a></li>
<li><a class="reference internal" href="#id8">Queueの設定</a></li>
<li><a class="reference internal" href="#id9">ルータの設定</a></li>
<li><a class="reference internal" href="#id10">QoSの設定</a></li>
<li><a class="reference internal" href="#id11">設定内容の確認</a></li>
<li><a class="reference internal" href="#id12">帯域計測</a></li>
</ul>
</li>
<li><a class="reference internal" href="#meter-tableqos">Meter Tableを使用したQoSの動作例</a><ul>
<li><a class="reference internal" href="#id13">環境構築</a></li>
<li><a class="reference internal" href="#id14">QoSの設定</a></li>
<li><a class="reference internal" href="#id15">設定内容の確認</a></li>
<li><a class="reference internal" href="#id16">帯域計測</a><ul>
<li><a class="reference internal" href="#af11">ベストエフォートと超過したAF11トラフィック</a></li>
<li><a class="reference internal" href="#af11af11">AF11の超過トラフィックとベストエフォートとAF11の契約帯域内トラフィック</a></li>
<li><a class="reference internal" href="#id17">AF11の超過トラフィックとAF11の超過トラフィック</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#rest-api">REST API一覧</a><ul>
<li><a class="reference internal" href="#id18">キューの状態の取得</a></li>
<li><a class="reference internal" href="#id19">キューの設定情報の取得</a></li>
<li><a class="reference internal" href="#id20">キューの設定</a></li>
<li><a class="reference internal" href="#id21">キューの削除</a></li>
<li><a class="reference internal" href="#id22">全QoSルールの取得</a></li>
<li><a class="reference internal" href="#id23">QoSルールの追加</a></li>
<li><a class="reference internal" href="#id24">QoSルールの削除</a></li>
<li><a class="reference internal" href="#id25">メーターテーブルの情報取得</a></li>
<li><a class="reference internal" href="#id26">メーターテーブルの設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="rest_router.html"
                        title="前の章へ">ルータ</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="switch_test_tool.html"
                        title="次の章へ">OpenFlowスイッチテストツール</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/rest_qos.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="検索" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="switch_test_tool.html" title="OpenFlowスイッチテストツール"
             >次へ</a> |</li>
        <li class="right" >
          <a href="rest_router.html" title="ルータ"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ryubook 1.0 ドキュメント</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, RYU project team.
    </div>
  </body>
</html>